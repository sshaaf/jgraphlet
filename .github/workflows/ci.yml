name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on ${{ matrix.os }} with Java ${{ matrix.java-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        java-version: [ '17', '21' ]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
        
    - name: Run tests
      run: mvn clean test -B
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-java-${{ matrix.java-version }}
        path: target/surefire-reports/
        retention-days: 7

  package:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Package project
      run: mvn clean package -B
      
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: jgraphlet-jar
        path: target/jgraphlet-*.jar
        retention-days: 30

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Run Maven verify
      run: mvn clean verify -B
      
    - name: Check code quality
      run: |
        echo "ğŸ” Performing code quality checks..."
        
        # Check for TODO/FIXME comments
        echo "ğŸ“ Checking for TODO/FIXME comments..."
        if find src/ -name "*.java" -exec grep -l "TODO\|FIXME" {} \; 2>/dev/null | head -5; then
          echo "â„¹ï¸  Found TODO/FIXME comments (consider addressing them)"
        else
          echo "âœ… No TODO/FIXME comments found"
        fi
        
        # Check for System.out.println in main code
        echo "ğŸ–¨ï¸  Checking for System.out.println usage..."
        if find src/main/ -name "*.java" -exec grep -l "System\.out\.println" {} \; 2>/dev/null; then
          echo "âš ï¸  Found System.out.println in main code - consider using proper logging"
        else
          echo "âœ… No System.out.println found in main code"
        fi
        
        # Verify thread-safety tests run successfully
        echo "ğŸ§µ Verifying thread-safety tests..."
        if mvn test -Dtest=TaskPipelineThreadSafetyTest -q; then
          echo "âœ… Thread-safety tests passed"
        else
          echo "âŒ Thread-safety tests failed"
          exit 1
        fi
        
        echo "âœ… Code quality checks completed"

  dependency-security:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Check dependencies
      run: |
        echo "ğŸ”’ Checking dependencies for security vulnerabilities..."
        mvn dependency:tree -B
        mvn dependency:analyze -B
        
    - name: Update dependency graph
      uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Validate PR
      run: |
        echo "ğŸ” Validating Pull Request..."
        
        # Run all tests to ensure nothing is broken
        mvn clean test -B
        
        # Ensure package builds successfully
        mvn package -B -DskipTests
        
        # Check that README examples are still valid
        echo "ğŸ“– Checking README examples..."
        if grep -q "try (TaskPipeline pipeline" README.md; then
          echo "âœ… README contains AutoCloseable examples"
        else
          echo "âš ï¸  README might need AutoCloseable examples"
        fi
        
        echo "âœ… PR validation completed"